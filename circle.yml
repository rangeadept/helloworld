machine:
  environment:
    PROJECT_NAME: adeptable-prod
    CLUSTER_NAME: svcprod-alpha-uc1
    CLUSTER_ZONE: us-central1-a
    DEBIAN_FRONTEND: noninteractive
    APP_NAME: helloworld

  services:
    - docker

dependencies:
  pre:
    - git clone git@github.com:rangeadept/_ci-scripts.git
    - _ci-scripts/setup-gke-environment.sh
    - docker build -t gcr.io/${PROJECT_NAME}/${APP_NAME}:${CIRCLE_SHA1} .
    # Using a separate tag command until Docker 1.10 is available on CircleCI, then we can use two tags in the build command above
    - docker tag -f gcr.io/${PROJECT_NAME}/${APP_NAME}:${CIRCLE_SHA1} gcr.io/${PROJECT_NAME}/${APP_NAME}:latest

test:
  post:
    - docker run -d -p 8080:8080 gcr.io/${PROJECT_NAME}/${APP_NAME}:${CIRCLE_SHA1}; sleep 1
    - curl --retry 10 --retry-delay 5 -v http://localhost:8080/view/fun

deployment:
  stage:
    branch: master
    commands:
      - envsubst < kubernetes/deployment.yaml.tmpl > k8-deployment.yaml
      - envsubst < kubernetes/service.yaml.tmpl > k8-service.yaml
      - sudo /opt/google-cloud-sdk/bin/gcloud docker push gcr.io/${PROJECT_NAME}/${APP_NAME}
      - _ci-scripts/set-kube-namespace.sh stage
      - kubectl apply -f ./k8-service.yaml
      - cat ./k8-deployment.yaml
      - kubectl apply -f ./k8-deployment.yaml
