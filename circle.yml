machine:
  environment:
    PROJECT_NAME: adeptable-prod
    CLUSTER_NAME: svcprod-alpha-uc1
    CLUSTER_ZONE: us-central1-a
    DEBIAN_FRONTEND: noninteractive
    APP_NAME: helloworld

  services:
    - docker

dependencies:
  pre:
    - git clone git@github.com:rangeadept/_ci-scripts.git
    - _ci-scripts/setup-gke-environment.sh
    - docker build -t gcr.io/${PROJECT_NAME}/${APP_NAME}:${CIRCLE_SHA1} .
    # Using a separate tag command until Docker 1.10 is available on CircleCI, then we can use two tags in the build command above
    - docker tag -f gcr.io/${PROJECT_NAME}/${APP_NAME}:${CIRCLE_SHA1} gcr.io/${PROJECT_NAME}/${APP_NAME}:latest

test:
  post:
    - docker run -d -p 8080:8080 gcr.io/${PROJECT_NAME}/${APP_NAME}:${CIRCLE_SHA1}; sleep 1
    - curl --retry 10 --retry-delay 5 -v http://localhost:8080/view/fun

deployment:
  alpha:
    branch: master
    commands:
      - _ci-scripts/deploy.sh test
  stage:
    # Release tags only (no -beta or -rc, only v111.111.111 
    tag:
      - /^v[0-9]+\.[0-9]+\.[0-9]+$/
    commands:
      - _ci-scripts/deploy.sh stage

  beta: 
    # *-beta tags only
    tag:
      - /^v[0-9]+\.[0-9]+\.[0-9]+-beta$/
    commands:
      - _ci-scripts/deploy.sh beta
